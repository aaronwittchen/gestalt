<template>
  <div class="flex flex-col flex-1 -m-5 min-h-0 text-[13px]" style="font-family: var(--ctp-font-mono);">
    <!-- Terminal header -->
    <div class="flex items-center gap-2 px-4 py-2 bg-[var(--ctp-crust)] border-b" style="border-color: color-mix(in srgb, var(--ctp-surface0), transparent 50%);">
      <span class="text-[var(--ctp-peach)]">~</span>
      <span class="text-[var(--ctp-overlay0)]">zsh</span>
    </div>
    <!-- Nvim overlay -->
    <NvimViewer
      v-if="nvimMode"
      :initial-file="nvimInitialFile"
      @quit="exitNvim"
    />
    <!-- Terminal body -->
    <div
      v-else
      ref="termBody"
      class="flex-1 overflow-y-auto p-4 bg-[var(--ctp-crust)]"
      @click="focusInput"
    >
      <div v-for="(line, i) in lines" :key="i">
        <div v-if="line.type === 'prompt'" class="flex gap-1">
          <span class="text-[var(--ctp-peach)]">{{ user }}@{{ host }}</span>
          <span class="text-[var(--ctp-blue)]">{{ line.cwd }}</span>
          <span class="text-[var(--ctp-mauve)]">$</span>
          <span class="text-[var(--ctp-text)]">{{ line.cmd }}</span>
        </div>
        <!-- eslint-disable-next-line vue/no-v-html -->
        <div v-else-if="line.html" class="text-[var(--ctp-subtext0)] whitespace-pre" v-html="line.text" />
        <div v-else class="text-[var(--ctp-subtext0)] whitespace-pre">{{ line.text }}</div>
      </div>
      <!-- Active prompt -->
      <div class="flex gap-1">
        <span class="text-[var(--ctp-peach)]">{{ user }}@{{ host }}</span>
        <span class="text-[var(--ctp-blue)]">{{ cwd }}</span>
        <span class="text-[var(--ctp-mauve)]">$</span>
        <span class="relative">
          <input
            ref="inputEl"
            v-model="currentInput"
            class="terminal-input bg-transparent text-[var(--ctp-text)] outline-none border-none w-64 caret-[var(--ctp-mauve)]"
            style="font-family: var(--ctp-font-mono);"
            spellcheck="false"
            @keydown.enter="executeCommand"
          >
        </span>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, nextTick, onMounted } from 'vue'
import NvimViewer from './NvimViewer.vue'

const user = 'guest'
const host = 'gestalt'
const cwd = ref('~')

interface PromptLine {
  type: 'prompt'
  cwd: string
  cmd: string
}

interface OutputLine {
  type: 'output'
  text: string
  html?: boolean
}

type Line = PromptLine | OutputLine

const lines = ref<Line[]>([])
const currentInput = ref('')
const inputEl = ref<HTMLInputElement | null>(null)
const termBody = ref<HTMLElement | null>(null)
const nvimMode = ref(false)
const nvimInitialFile = ref('')

const commands: Record<string, () => string | { text: string; html: true }> = {
  pwd: () => '/home/guest',
  ls: () => 'Documents  Downloads  Desktop  .config  .bashrc',
  whoami: () => user,
  hostname: () => host,
  date: () => new Date().toLocaleString(),
  uname: () => 'Linux gestalt 6.18.7-arch1-1 x86_64 GNU/Linux',
  uptime: () => ' ' + new Date().toLocaleTimeString() + ' up 42 days, 3:14, 1 user, load average: 0.42, 0.38, 0.35',
  clear: () => '__CLEAR__',
  help: () => 'Available commands: pwd, ls, whoami, hostname, date, uname, uptime, clear, help, neofetch, htop, nvim',
  htop: () => {
    const bar = (label: string, pct: number, color: string) => {
      const width = 40
      const filled = Math.round((pct / 100) * width)
      const empty = width - filled
      return `  <span style="color:var(--ctp-blue)">${label}</span> [<span style="color:${color}">${'|'.repeat(filled)}</span>${' '.repeat(empty)}] <span style="color:var(--ctp-text)">${pct.toFixed(1)}%</span>`
    }
    const cpus = Array.from({ length: 4 }, (_, i) => bar(`CPU${i}`, Math.random() * 85 + 5, 'var(--ctp-green)'))
    const mem = bar('Mem ', 38 + Math.random() * 25, 'var(--ctp-mauve)')
    const swp = bar('Swp ', 2 + Math.random() * 10, 'var(--ctp-peach)')
    const procs = [
      { pid: 1, user: 'root', cpu: '0.0', mem: '0.1', cmd: 'systemd' },
      { pid: 847, user: 'guest', cpu: '4.2', mem: '2.8', cmd: 'node' },
      { pid: 1203, user: 'guest', cpu: '2.1', mem: '1.4', cmd: 'astro dev' },
      { pid: 1344, user: 'guest', cpu: '1.8', mem: '3.2', cmd: 'bun install' },
      { pid: 1502, user: 'guest', cpu: '0.9', mem: '0.6', cmd: 'vue-tsc' },
      { pid: 1689, user: 'guest', cpu: '0.3', mem: '0.2', cmd: 'zsh' },
    ]
    const header = `  <span style="color:var(--ctp-blue)">  PID USER      %CPU  %MEM  COMMAND</span>`
    const rows = procs.map(p =>
      `  <span style="color:var(--ctp-green)">${String(p.pid).padStart(5)}</span> ${p.user.padEnd(9)} ${p.cpu.padStart(5)}  ${p.mem.padStart(4)}  <span style="color:var(--ctp-text)">${p.cmd}</span>`
    )
    return { html: true as const, text: [
      ...cpus, '', mem, swp, '',
      header, ...rows,
    ].join('\n') }
  },
  neofetch: () => ({ html: true as const, text: `                                                  ${user}@${host}
        <span style="color:rgb(43,32,23)">.</span><span style="color:rgb(142,95,75)">;</span><span style="color:rgb(55,42,34)">.</span>                         <span style="color:rgb(0,0,0)"> </span><span style="color:rgb(118,81,68)">:</span><span style="color:rgb(100,67,53)">,</span><span style="color:rgb(0,0,0)"> </span>          -----------
        <span style="color:rgb(111,76,60)">:</span><span style="color:rgb(231,141,111)">*</span><span style="color:rgb(182,113,90)">+</span><span style="color:rgb(143,93,78)">;</span><span style="color:rgb(83,53,42)">,</span>                     <span style="color:rgb(31,22,22)"> </span><span style="color:rgb(121,82,66)">:</span><span style="color:rgb(178,114,91)">+</span><span style="color:rgb(219,134,107)">*</span><span style="color:rgb(228,143,112)">*</span><span style="color:rgb(55,32,27)">.</span>          OS: Gestalt Linux x86_64
       <span style="color:rgb(24,18,18)"> </span><span style="color:rgb(193,124,101)">+</span><span style="color:rgb(141,64,56)">:</span><span style="color:rgb(136,60,52)">:</span><span style="color:rgb(172,95,78)">;</span><span style="color:rgb(140,91,75)">;</span><span style="color:rgb(83,53,42)">,</span><span style="color:rgb(119,74,59)">:</span><span style="color:rgb(148,99,108)">;</span><span style="color:rgb(198,127,164)">+</span><span style="color:rgb(197,125,159)">+</span><span style="color:rgb(198,127,161)">+</span><span style="color:rgb(198,128,165)">*</span><span style="color:rgb(198,130,165)">*</span><span style="color:rgb(197,129,164)">*</span><span style="color:rgb(197,131,165)">*</span><span style="color:rgb(197,129,164)">*</span><span style="color:rgb(198,130,166)">*</span><span style="color:rgb(198,130,168)">*</span><span style="color:rgb(198,130,167)">*</span><span style="color:rgb(200,130,168)">*</span><span style="color:rgb(198,131,167)">*</span><span style="color:rgb(201,131,170)">*</span><span style="color:rgb(199,131,170)">*</span><span style="color:rgb(203,138,175)">*</span><span style="color:rgb(141,103,116)">;</span><span style="color:rgb(88,53,39)">,</span><span style="color:rgb(118,74,59)">:</span><span style="color:rgb(157,93,74)">;</span><span style="color:rgb(147,70,57)">:</span><span style="color:rgb(117,44,38)">,</span><span style="color:rgb(209,124,101)">+</span><span style="color:rgb(113,76,61)">:</span>          Kernel: 6.18.7-arch1-1
       <span style="color:rgb(110,76,63)">:</span><span style="color:rgb(210,121,96)">+</span><span style="color:rgb(81,31,29)">.</span><span style="color:rgb(75,47,47)">,</span><span style="color:rgb(61,49,50)">,</span><span style="color:rgb(204,204,205)">O</span><span style="color:rgb(167,160,158)">*</span><span style="color:rgb(131,103,93)">;</span><span style="color:rgb(177,117,144)">+</span><span style="color:rgb(217,138,181)">*</span><span style="color:rgb(212,135,178)">*</span><span style="color:rgb(214,137,180)">*</span><span style="color:rgb(213,138,182)">*</span><span style="color:rgb(214,140,182)">*</span><span style="color:rgb(213,140,183)">*</span><span style="color:rgb(212,140,182)">*</span><span style="color:rgb(212,140,181)">*</span><span style="color:rgb(211,140,182)">*</span><span style="color:rgb(211,140,182)">*</span><span style="color:rgb(211,140,181)">*</span><span style="color:rgb(211,140,182)">*</span><span style="color:rgb(211,140,181)">*</span><span style="color:rgb(211,141,182)">*</span><span style="color:rgb(212,143,184)">*</span><span style="color:rgb(214,144,188)">*</span><span style="color:rgb(157,113,132)">+</span><span style="color:rgb(132,110,102)">;</span><span style="color:rgb(187,179,178)">o</span><span style="color:rgb(156,153,154)">*</span><span style="color:rgb(70,50,50)">,</span><span style="color:rgb(87,54,54)">,</span><span style="color:rgb(110,51,46)">,</span><span style="color:rgb(191,115,94)">+</span><span style="color:rgb(43,28,20)">.</span>         Shell: zsh 5.9
      <span style="color:rgb(28,20,19)"> </span><span style="color:rgb(154,101,83)">;</span><span style="color:rgb(113,77,70)">:</span><span style="color:rgb(124,120,121)">;</span><span style="color:rgb(228,226,225)">O</span><span style="color:rgb(224,216,214)">O</span><span style="color:rgb(255,255,255)">@</span><span style="color:rgb(202,200,195)">o</span><span style="color:rgb(79,75,78)">:</span><span style="color:rgb(161,108,138)">;</span><span style="color:rgb(208,134,176)">*</span><span style="color:rgb(199,131,169)">*</span><span style="color:rgb(202,134,172)">*</span><span style="color:rgb(203,135,173)">*</span><span style="color:rgb(202,135,173)">*</span><span style="color:rgb(203,136,176)">*</span><span style="color:rgb(202,136,176)">*</span><span style="color:rgb(204,137,178)">*</span><span style="color:rgb(204,137,178)">*</span><span style="color:rgb(205,137,179)">*</span><span style="color:rgb(205,137,178)">*</span><span style="color:rgb(205,137,178)">*</span><span style="color:rgb(204,138,178)">*</span><span style="color:rgb(205,139,179)">*</span><span style="color:rgb(206,140,183)">*</span><span style="color:rgb(207,141,184)">*</span><span style="color:rgb(119,86,108)">:</span><span style="color:rgb(120,122,122)">;</span><span style="color:rgb(234,231,227)">#</span><span style="color:rgb(255,247,245)">#</span><span style="color:rgb(246,240,238)">#</span><span style="color:rgb(239,235,233)">#</span><span style="color:rgb(101,96,96)">:</span><span style="color:rgb(144,103,95)">;</span><span style="color:rgb(101,66,56)">,</span><span style="color:rgb(23,15,15)"> </span>        Theme: Catppuccin Mocha
     <span style="color:rgb(28,23,40)">.</span><span style="color:rgb(119,79,65)">:</span><span style="color:rgb(170,103,78)">;</span><span style="color:rgb(79,83,83)">:</span><span style="color:rgb(251,248,245)">#</span><span style="color:rgb(246,242,238)">#</span><span style="color:rgb(208,204,201)">O</span><span style="color:rgb(101,98,99)">:</span><span style="color:rgb(108,88,97)">:</span><span style="color:rgb(160,102,133)">;</span><span style="color:rgb(216,142,182)">*</span><span style="color:rgb(199,133,170)">*</span><span style="color:rgb(203,137,174)">*</span><span style="color:rgb(204,139,176)">*</span><span style="color:rgb(202,140,177)">*</span><span style="color:rgb(203,140,177)">*</span><span style="color:rgb(204,141,180)">*</span><span style="color:rgb(205,141,181)">*</span><span style="color:rgb(205,142,181)">*</span><span style="color:rgb(206,143,181)">*</span><span style="color:rgb(207,142,183)">*</span><span style="color:rgb(207,142,184)">*</span><span style="color:rgb(208,142,184)">*</span><span style="color:rgb(208,143,184)">*</span><span style="color:rgb(209,143,185)">*</span><span style="color:rgb(208,143,185)">*</span><span style="color:rgb(210,145,187)">*</span><span style="color:rgb(218,151,194)">*</span><span style="color:rgb(167,117,148)">+</span><span style="color:rgb(135,102,122)">;</span><span style="color:rgb(106,99,99)">:</span><span style="color:rgb(227,222,217)">O</span><span style="color:rgb(206,197,194)">o</span><span style="color:rgb(244,239,234)">#</span><span style="color:rgb(110,119,120)">;</span><span style="color:rgb(120,74,56)">:</span><span style="color:rgb(89,54,41)">,</span>        WM: gestalt-wm
     <span style="color:rgb(89,65,75)">,</span><span style="color:rgb(181,121,105)">+</span><span style="color:rgb(220,137,124)">*</span><span style="color:rgb(94,70,76)">:</span><span style="color:rgb(134,113,119)">;</span><span style="color:rgb(137,104,116)">;</span><span style="color:rgb(132,106,116)">;</span><span style="color:rgb(130,86,107)">:</span><span style="color:rgb(207,136,172)">*</span><span style="color:rgb(206,140,176)">*</span><span style="color:rgb(200,137,171)">*</span><span style="color:rgb(204,140,176)">*</span><span style="color:rgb(205,141,177)">*</span><span style="color:rgb(205,142,179)">*</span><span style="color:rgb(205,143,180)">*</span><span style="color:rgb(206,144,181)">*</span><span style="color:rgb(207,144,183)">*</span><span style="color:rgb(208,144,185)">*</span><span style="color:rgb(209,145,187)">*</span><span style="color:rgb(210,146,188)">*</span><span style="color:rgb(210,146,188)">*</span><span style="color:rgb(210,146,188)">*</span><span style="color:rgb(210,147,189)">*</span><span style="color:rgb(211,147,189)">*</span><span style="color:rgb(211,148,189)">*</span><span style="color:rgb(212,148,190)">*</span><span style="color:rgb(212,149,190)">*</span><span style="color:rgb(210,149,189)">*</span><span style="color:rgb(222,157,200)">o</span><span style="color:rgb(222,155,201)">o</span><span style="color:rgb(167,120,152)">+</span><span style="color:rgb(166,126,152)">+</span><span style="color:rgb(159,116,144)">+</span><span style="color:rgb(142,114,132)">;</span><span style="color:rgb(109,83,99)">:</span><span style="color:rgb(231,158,157)">o</span><span style="color:rgb(170,113,109)">+</span><span style="color:rgb(52,40,48)">.</span>       Terminal: gestalt-term
    <span style="color:rgb(183,127,142)">+</span><span style="color:rgb(183,118,144)">+</span><span style="color:rgb(182,115,142)">+</span><span style="color:rgb(177,107,136)">+</span><span style="color:rgb(183,108,136)">+</span><span style="color:rgb(175,101,129)">;</span><span style="color:rgb(188,112,142)">+</span><span style="color:rgb(191,119,151)">+</span><span style="color:rgb(206,135,169)">*</span><span style="color:rgb(199,133,167)">*</span><span style="color:rgb(200,137,172)">*</span><span style="color:rgb(203,142,176)">*</span><span style="color:rgb(206,145,179)">*</span><span style="color:rgb(209,146,181)">*</span><span style="color:rgb(208,148,182)">*</span><span style="color:rgb(208,148,184)">*</span><span style="color:rgb(208,149,184)">*</span><span style="color:rgb(209,149,186)">*</span><span style="color:rgb(211,149,190)">*</span><span style="color:rgb(211,150,191)">*</span><span style="color:rgb(212,151,191)">*</span><span style="color:rgb(212,152,191)">*</span><span style="color:rgb(212,152,191)">*</span><span style="color:rgb(212,153,191)">*</span><span style="color:rgb(212,153,192)">*</span><span style="color:rgb(212,154,192)">*</span><span style="color:rgb(213,155,193)">*</span><span style="color:rgb(213,156,193)">*</span><span style="color:rgb(212,156,193)">*</span><span style="color:rgb(211,156,193)">*</span><span style="color:rgb(212,157,194)">*</span><span style="color:rgb(222,165,204)">o</span><span style="color:rgb(222,163,204)">o</span><span style="color:rgb(226,167,208)">o</span><span style="color:rgb(222,162,204)">o</span><span style="color:rgb(229,171,213)">o</span><span style="color:rgb(217,164,208)">o</span><span style="color:rgb(222,167,209)">o</span><span style="color:rgb(213,160,198)">o</span><span style="color:rgb(213,166,195)">o</span>      Packages: 42 (bun)
    <span style="color:rgb(179,119,141)">+</span><span style="color:rgb(192,122,151)">+</span><span style="color:rgb(175,107,135)">+</span><span style="color:rgb(174,103,128)">;</span><span style="color:rgb(175,102,127)">;</span><span style="color:rgb(179,105,132)">+</span><span style="color:rgb(181,108,135)">+</span><span style="color:rgb(186,115,145)">+</span><span style="color:rgb(189,120,153)">+</span><span style="color:rgb(195,127,163)">+</span><span style="color:rgb(200,134,170)">*</span><span style="color:rgb(203,140,175)">*</span><span style="color:rgb(207,144,178)">*</span><span style="color:rgb(207,148,182)">*</span><span style="color:rgb(207,150,184)">*</span><span style="color:rgb(208,151,186)">*</span><span style="color:rgb(210,152,189)">*</span><span style="color:rgb(210,154,191)">*</span><span style="color:rgb(211,155,192)">*</span><span style="color:rgb(211,156,192)">*</span><span style="color:rgb(211,156,193)">*</span><span style="color:rgb(212,157,193)">*</span><span style="color:rgb(212,158,194)">*</span><span style="color:rgb(212,158,194)">*</span><span style="color:rgb(213,159,195)">o</span><span style="color:rgb(213,160,195)">o</span><span style="color:rgb(213,160,196)">o</span><span style="color:rgb(213,160,196)">o</span><span style="color:rgb(213,161,196)">o</span><span style="color:rgb(214,161,197)">o</span><span style="color:rgb(214,162,198)">o</span><span style="color:rgb(213,161,197)">o</span><span style="color:rgb(214,163,198)">o</span><span style="color:rgb(214,164,200)">o</span><span style="color:rgb(215,166,202)">o</span><span style="color:rgb(214,164,201)">o</span><span style="color:rgb(216,165,201)">o</span><span style="color:rgb(217,162,202)">o</span><span style="color:rgb(234,175,219)">o</span><span style="color:rgb(215,164,197)">o</span>    
    <span style="color:rgb(178,115,137)">+</span><span style="color:rgb(188,117,146)">+</span><span style="color:rgb(174,103,129)">;</span><span style="color:rgb(173,99,123)">;</span><span style="color:rgb(173,97,122)">;</span><span style="color:rgb(174,98,124)">;</span><span style="color:rgb(179,103,130)">+</span><span style="color:rgb(184,111,141)">+</span><span style="color:rgb(188,118,152)">+</span><span style="color:rgb(193,124,160)">+</span><span style="color:rgb(197,130,167)">*</span><span style="color:rgb(201,136,171)">*</span><span style="color:rgb(204,140,176)">*</span><span style="color:rgb(204,145,181)">*</span><span style="color:rgb(205,149,184)">*</span><span style="color:rgb(209,151,188)">*</span><span style="color:rgb(209,153,190)">*</span><span style="color:rgb(209,156,191)">*</span><span style="color:rgb(209,156,192)">*</span><span style="color:rgb(210,157,193)">*</span><span style="color:rgb(212,158,194)">*</span><span style="color:rgb(213,158,195)">o</span><span style="color:rgb(213,159,195)">o</span><span style="color:rgb(213,160,196)">o</span><span style="color:rgb(213,161,197)">o</span><span style="color:rgb(213,161,197)">o</span><span style="color:rgb(213,161,197)">o</span><span style="color:rgb(213,162,197)">o</span><span style="color:rgb(213,162,197)">o</span><span style="color:rgb(213,161,197)">o</span><span style="color:rgb(214,162,197)">o</span><span style="color:rgb(214,162,198)">o</span><span style="color:rgb(215,163,199)">o</span><span style="color:rgb(215,164,200)">o</span><span style="color:rgb(216,164,201)">o</span><span style="color:rgb(215,165,202)">o</span><span style="color:rgb(216,164,202)">o</span><span style="color:rgb(217,162,202)">o</span><span style="color:rgb(229,171,214)">o</span><span style="color:rgb(217,163,201)">o</span>    
    <span style="color:rgb(176,109,132)">+</span><span style="color:rgb(184,108,138)">+</span><span style="color:rgb(173,99,124)">;</span><span style="color:rgb(172,100,123)">;</span><span style="color:rgb(172,100,122)">;</span><span style="color:rgb(173,99,123)">;</span><span style="color:rgb(177,101,128)">;</span><span style="color:rgb(181,106,136)">+</span><span style="color:rgb(187,112,147)">+</span><span style="color:rgb(191,119,156)">+</span><span style="color:rgb(194,125,162)">+</span><span style="color:rgb(198,130,168)">*</span><span style="color:rgb(200,135,172)">*</span><span style="color:rgb(202,139,177)">*</span><span style="color:rgb(205,142,183)">*</span><span style="color:rgb(207,146,186)">*</span><span style="color:rgb(207,148,187)">*</span><span style="color:rgb(208,151,188)">*</span><span style="color:rgb(209,153,190)">*</span><span style="color:rgb(210,155,191)">*</span><span style="color:rgb(211,157,193)">*</span><span style="color:rgb(212,158,194)">*</span><span style="color:rgb(212,158,194)">*</span><span style="color:rgb(212,159,194)">o</span><span style="color:rgb(213,159,195)">o</span><span style="color:rgb(212,159,195)">o</span><span style="color:rgb(212,160,195)">o</span><span style="color:rgb(212,159,195)">o</span><span style="color:rgb(213,159,195)">o</span><span style="color:rgb(212,158,194)">*</span><span style="color:rgb(213,159,196)">o</span><span style="color:rgb(214,159,197)">o</span><span style="color:rgb(214,160,197)">o</span><span style="color:rgb(215,160,199)">o</span><span style="color:rgb(216,161,200)">o</span><span style="color:rgb(215,160,200)">o</span><span style="color:rgb(215,160,200)">o</span><span style="color:rgb(215,160,200)">o</span><span style="color:rgb(229,170,213)">o</span><span style="color:rgb(216,162,199)">o</span>    
    <span style="color:rgb(175,104,130)">+</span><span style="color:rgb(182,104,134)">+</span><span style="color:rgb(172,98,122)">;</span><span style="color:rgb(171,99,121)">;</span><span style="color:rgb(172,100,121)">;</span><span style="color:rgb(172,101,121)">;</span><span style="color:rgb(175,103,126)">;</span><span style="color:rgb(180,106,135)">+</span><span style="color:rgb(184,111,144)">+</span><span style="color:rgb(189,117,154)">+</span><span style="color:rgb(193,123,160)">+</span><span style="color:rgb(195,127,165)">+</span><span style="color:rgb(198,132,171)">*</span><span style="color:rgb(201,136,176)">*</span><span style="color:rgb(203,139,180)">*</span><span style="color:rgb(206,141,183)">*</span><span style="color:rgb(207,144,185)">*</span><span style="color:rgb(207,147,186)">*</span><span style="color:rgb(208,149,188)">*</span><span style="color:rgb(208,152,190)">*</span><span style="color:rgb(208,154,191)">*</span><span style="color:rgb(209,155,191)">*</span><span style="color:rgb(210,155,192)">*</span><span style="color:rgb(210,156,192)">*</span><span style="color:rgb(210,156,192)">*</span><span style="color:rgb(211,156,192)">*</span><span style="color:rgb(210,156,192)">*</span><span style="color:rgb(210,155,193)">*</span><span style="color:rgb(210,154,193)">*</span><span style="color:rgb(210,154,193)">*</span><span style="color:rgb(211,155,194)">*</span><span style="color:rgb(211,156,195)">*</span><span style="color:rgb(212,157,196)">*</span><span style="color:rgb(212,157,196)">*</span><span style="color:rgb(212,157,195)">*</span><span style="color:rgb(214,158,197)">o</span><span style="color:rgb(217,159,200)">o</span><span style="color:rgb(215,159,200)">o</span><span style="color:rgb(227,169,213)">o</span><span style="color:rgb(215,163,198)">o</span>    
    <span style="color:rgb(174,102,128)">;</span><span style="color:rgb(183,103,132)">+</span><span style="color:rgb(172,98,121)">;</span><span style="color:rgb(172,97,118)">;</span><span style="color:rgb(171,99,118)">;</span><span style="color:rgb(174,100,121)">;</span><span style="color:rgb(175,103,124)">;</span><span style="color:rgb(178,107,133)">+</span><span style="color:rgb(183,112,144)">+</span><span style="color:rgb(187,116,150)">+</span><span style="color:rgb(190,120,157)">+</span><span style="color:rgb(193,125,162)">+</span><span style="color:rgb(196,129,167)">*</span><span style="color:rgb(199,133,173)">*</span><span style="color:rgb(201,136,177)">*</span><span style="color:rgb(203,138,180)">*</span><span style="color:rgb(205,142,184)">*</span><span style="color:rgb(207,145,186)">*</span><span style="color:rgb(207,146,186)">*</span><span style="color:rgb(207,148,187)">*</span><span style="color:rgb(207,148,189)">*</span><span style="color:rgb(207,150,189)">*</span><span style="color:rgb(208,151,190)">*</span><span style="color:rgb(208,151,190)">*</span><span style="color:rgb(208,151,190)">*</span><span style="color:rgb(209,150,190)">*</span><span style="color:rgb(208,151,190)">*</span><span style="color:rgb(208,150,190)">*</span><span style="color:rgb(209,150,191)">*</span><span style="color:rgb(209,151,191)">*</span><span style="color:rgb(209,152,192)">*</span><span style="color:rgb(210,153,193)">*</span><span style="color:rgb(209,153,192)">*</span><span style="color:rgb(214,156,198)">*</span><span style="color:rgb(219,159,202)">o</span><span style="color:rgb(212,157,197)">*</span><span style="color:rgb(199,150,188)">*</span><span style="color:rgb(209,156,197)">*</span><span style="color:rgb(233,173,218)">o</span><span style="color:rgb(213,162,195)">o</span>    
    <span style="color:rgb(174,102,124)">;</span><span style="color:rgb(185,104,131)">+</span><span style="color:rgb(172,96,120)">;</span><span style="color:rgb(172,95,117)">;</span><span style="color:rgb(171,96,116)">;</span><span style="color:rgb(173,97,118)">;</span><span style="color:rgb(174,101,123)">;</span><span style="color:rgb(178,105,131)">+</span><span style="color:rgb(184,109,142)">+</span><span style="color:rgb(189,115,151)">+</span><span style="color:rgb(198,125,164)">+</span><span style="color:rgb(201,127,168)">*</span><span style="color:rgb(199,129,169)">*</span><span style="color:rgb(204,134,176)">*</span><span style="color:rgb(209,139,183)">*</span><span style="color:rgb(209,140,185)">*</span><span style="color:rgb(205,140,182)">*</span><span style="color:rgb(205,142,183)">*</span><span style="color:rgb(206,143,185)">*</span><span style="color:rgb(207,144,186)">*</span><span style="color:rgb(207,145,187)">*</span><span style="color:rgb(208,145,188)">*</span><span style="color:rgb(208,146,188)">*</span><span style="color:rgb(207,146,188)">*</span><span style="color:rgb(208,146,189)">*</span><span style="color:rgb(208,147,189)">*</span><span style="color:rgb(207,148,189)">*</span><span style="color:rgb(208,148,189)">*</span><span style="color:rgb(208,149,189)">*</span><span style="color:rgb(207,150,189)">*</span><span style="color:rgb(208,150,190)">*</span><span style="color:rgb(208,150,190)">*</span><span style="color:rgb(215,154,197)">*</span><span style="color:rgb(193,143,179)">*</span><span style="color:rgb(150,125,142)">+</span><span style="color:rgb(122,112,119)">;</span><span style="color:rgb(104,99,104)">:</span><span style="color:rgb(105,95,102)">:</span><span style="color:rgb(198,149,182)">*</span><span style="color:rgb(224,170,203)">o</span>    
    <span style="color:rgb(174,111,125)">+</span><span style="color:rgb(182,106,131)">+</span><span style="color:rgb(172,94,119)">;</span><span style="color:rgb(171,93,115)">;</span><span style="color:rgb(170,94,115)">;</span><span style="color:rgb(172,95,117)">;</span><span style="color:rgb(174,97,122)">;</span><span style="color:rgb(178,101,129)">;</span><span style="color:rgb(181,106,139)">+</span><span style="color:rgb(183,107,140)">+</span><span style="color:rgb(137,81,103)">:</span><span style="color:rgb(94,63,74)">,</span><span style="color:rgb(93,72,77)">:</span><span style="color:rgb(107,86,95)">:</span><span style="color:rgb(132,104,119)">;</span><span style="color:rgb(164,122,148)">+</span><span style="color:rgb(200,138,178)">*</span><span style="color:rgb(205,139,182)">*</span><span style="color:rgb(205,140,182)">*</span><span style="color:rgb(205,141,184)">*</span><span style="color:rgb(206,142,186)">*</span><span style="color:rgb(207,144,187)">*</span><span style="color:rgb(207,144,187)">*</span><span style="color:rgb(208,144,187)">*</span><span style="color:rgb(208,145,188)">*</span><span style="color:rgb(208,145,188)">*</span><span style="color:rgb(208,145,188)">*</span><span style="color:rgb(209,145,189)">*</span><span style="color:rgb(208,146,189)">*</span><span style="color:rgb(207,148,189)">*</span><span style="color:rgb(206,148,188)">*</span><span style="color:rgb(213,154,195)">*</span><span style="color:rgb(185,132,166)">+</span><span style="color:rgb(84,72,69)">,</span><span style="color:rgb(80,75,67)">,</span><span style="color:rgb(82,75,68)">,</span><span style="color:rgb(77,70,63)">,</span><span style="color:rgb(71,62,52)">,</span><span style="color:rgb(172,130,153)">+</span><span style="color:rgb(255,194,230)">O</span>    
     <span style="color:rgb(171,105,121)">;</span><span style="color:rgb(186,104,129)">+</span><span style="color:rgb(168,92,113)">;</span><span style="color:rgb(168,94,113)">;</span><span style="color:rgb(171,95,116)">;</span><span style="color:rgb(173,97,122)">;</span><span style="color:rgb(175,100,126)">;</span><span style="color:rgb(180,98,125)">;</span><span style="color:rgb(132,69,74)">:</span><span style="color:rgb(43,32,20)">.</span><span style="color:rgb(50,42,32)">.</span><span style="color:rgb(58,50,42)">,</span><span style="color:rgb(62,55,47)">,</span><span style="color:rgb(68,62,54)">,</span><span style="color:rgb(67,66,56)">,</span><span style="color:rgb(125,96,109)">;</span><span style="color:rgb(209,142,186)">*</span><span style="color:rgb(204,139,181)">*</span><span style="color:rgb(206,140,182)">*</span><span style="color:rgb(205,141,184)">*</span><span style="color:rgb(205,142,185)">*</span><span style="color:rgb(206,143,186)">*</span><span style="color:rgb(206,143,186)">*</span><span style="color:rgb(206,143,186)">*</span><span style="color:rgb(207,144,187)">*</span><span style="color:rgb(207,144,187)">*</span><span style="color:rgb(207,145,188)">*</span><span style="color:rgb(208,145,188)">*</span><span style="color:rgb(208,145,188)">*</span><span style="color:rgb(206,146,187)">*</span><span style="color:rgb(215,152,196)">*</span><span style="color:rgb(172,123,152)">+</span><span style="color:rgb(75,58,51)">,</span><span style="color:rgb(78,63,54)">,</span><span style="color:rgb(84,66,58)">,</span><span style="color:rgb(99,75,75)">:</span><span style="color:rgb(182,133,159)">+</span><span style="color:rgb(216,162,196)">o</span>     
      <span style="color:rgb(174,100,115)">;</span><span style="color:rgb(183,100,121)">;</span><span style="color:rgb(170,93,114)">;</span><span style="color:rgb(168,92,113)">;</span><span style="color:rgb(172,94,117)">;</span><span style="color:rgb(174,97,124)">;</span><span style="color:rgb(178,98,125)">;</span><span style="color:rgb(151,80,94)">;</span><span style="color:rgb(80,52,44)">,</span><span style="color:rgb(63,47,36)">.</span><span style="color:rgb(62,48,35)">.</span><span style="color:rgb(64,50,37)">,</span><span style="color:rgb(67,53,43)">,</span><span style="color:rgb(78,60,53)">,</span><span style="color:rgb(150,105,127)">;</span><span style="color:rgb(207,140,184)">*</span><span style="color:rgb(202,138,180)">*</span><span style="color:rgb(205,140,182)">*</span><span style="color:rgb(206,141,183)">*</span><span style="color:rgb(204,141,183)">*</span><span style="color:rgb(205,141,184)">*</span><span style="color:rgb(204,141,184)">*</span><span style="color:rgb(204,141,184)">*</span><span style="color:rgb(204,141,183)">*</span><span style="color:rgb(204,141,184)">*</span><span style="color:rgb(205,141,185)">*</span><span style="color:rgb(205,142,185)">*</span><span style="color:rgb(206,143,186)">*</span><span style="color:rgb(207,142,186)">*</span><span style="color:rgb(206,144,186)">*</span><span style="color:rgb(210,148,191)">*</span><span style="color:rgb(192,135,172)">*</span><span style="color:rgb(177,126,156)">+</span><span style="color:rgb(188,136,169)">*</span><span style="color:rgb(216,154,198)">*</span><span style="color:rgb(223,161,205)">o</span>      
       <span style="color:rgb(173,97,110)">;</span><span style="color:rgb(174,92,110)">;</span><span style="color:rgb(170,93,112)">;</span><span style="color:rgb(171,96,116)">;</span><span style="color:rgb(174,97,123)">;</span><span style="color:rgb(177,100,131)">;</span><span style="color:rgb(185,106,142)">+</span><span style="color:rgb(178,104,137)">+</span><span style="color:rgb(156,96,121)">;</span><span style="color:rgb(146,92,113)">;</span><span style="color:rgb(147,95,115)">;</span><span style="color:rgb(157,103,130)">;</span><span style="color:rgb(184,121,159)">+</span><span style="color:rgb(205,137,179)">*</span><span style="color:rgb(201,134,176)">*</span><span style="color:rgb(202,136,177)">*</span><span style="color:rgb(203,138,180)">*</span><span style="color:rgb(204,139,180)">*</span><span style="color:rgb(202,138,181)">*</span><span style="color:rgb(201,137,182)">*</span><span style="color:rgb(200,137,181)">*</span><span style="color:rgb(201,137,181)">*</span><span style="color:rgb(203,138,182)">*</span><span style="color:rgb(204,140,183)">*</span><span style="color:rgb(204,142,186)">*</span><span style="color:rgb(205,143,187)">*</span><span style="color:rgb(204,144,187)">*</span><span style="color:rgb(205,146,187)">*</span><span style="color:rgb(204,147,188)">*</span><span style="color:rgb(204,147,187)">*</span><span style="color:rgb(210,146,188)">*</span><span style="color:rgb(215,141,189)">*</span><span style="color:rgb(220,132,184)">*</span><span style="color:rgb(206,141,176)">*</span>       
        <span style="color:rgb(170,76,85)">;</span><span style="color:rgb(174,67,87)">:</span><span style="color:rgb(173,73,95)">;</span><span style="color:rgb(171,85,107)">;</span><span style="color:rgb(177,96,121)">;</span><span style="color:rgb(182,105,134)">+</span><span style="color:rgb(186,113,147)">+</span><span style="color:rgb(194,121,158)">+</span><span style="color:rgb(198,126,165)">+</span><span style="color:rgb(198,129,168)">*</span><span style="color:rgb(205,132,175)">*</span><span style="color:rgb(212,135,179)">*</span><span style="color:rgb(209,135,177)">*</span><span style="color:rgb(212,138,180)">*</span><span style="color:rgb(212,139,181)">*</span><span style="color:rgb(212,139,182)">*</span><span style="color:rgb(212,139,182)">*</span><span style="color:rgb(211,138,181)">*</span><span style="color:rgb(209,137,178)">*</span><span style="color:rgb(206,134,176)">*</span><span style="color:rgb(202,132,172)">*</span><span style="color:rgb(199,129,168)">*</span><span style="color:rgb(198,127,166)">+</span><span style="color:rgb(206,124,163)">+</span><span style="color:rgb(205,118,158)">+</span><span style="color:rgb(199,110,152)">+</span><span style="color:rgb(199,102,149)">+</span><span style="color:rgb(202,92,145)">+</span><span style="color:rgb(205,81,142)">;</span><span style="color:rgb(206,68,135)">;</span><span style="color:rgb(208,59,133)">;</span><span style="color:rgb(217,61,141)">;</span><span style="color:rgb(219,76,148)">;</span><span style="color:rgb(215,104,156)">+</span>      
         <span style="color:rgb(175,45,67)">:</span><span style="color:rgb(169,33,66)">:</span><span style="color:rgb(165,30,71)">,</span><span style="color:rgb(172,36,81)">:</span><span style="color:rgb(179,46,95)">:</span><span style="color:rgb(185,56,107)">:</span><span style="color:rgb(189,66,115)">;</span><span style="color:rgb(193,74,123)">;</span><span style="color:rgb(203,85,135)">;</span><span style="color:rgb(193,95,137)">+</span><span style="color:rgb(190,116,150)">+</span><span style="color:rgb(193,120,154)">+</span><span style="color:rgb(192,120,154)">+</span><span style="color:rgb(194,122,157)">+</span><span style="color:rgb(193,120,154)">+</span><span style="color:rgb(195,121,154)">+</span><span style="color:rgb(193,123,155)">+</span><span style="color:rgb(193,122,153)">+</span><span style="color:rgb(194,121,149)">+</span><span style="color:rgb(193,117,147)">+</span><span style="color:rgb(192,117,144)">+</span><span style="color:rgb(177,92,120)">;</span><span style="color:rgb(159,36,58)">,</span><span style="color:rgb(164,26,50)">,</span><span style="color:rgb(174,25,59)">,</span><span style="color:rgb(195,26,77)">:</span><span style="color:rgb(208,31,95)">:</span><span style="color:rgb(216,38,110)">:</span><span style="color:rgb(220,50,125)">;</span><span style="color:rgb(226,66,140)">;</span><span style="color:rgb(232,81,154)">+</span><span style="color:rgb(255,96,175)">+</span><span style="color:rgb(220,95,154)">+</span>      
         <span style="color:rgb(180,55,69)">:</span><span style="color:rgb(204,51,80)">:</span><span style="color:rgb(211,44,95)">:</span><span style="color:rgb(210,43,106)">:</span><span style="color:rgb(210,46,116)">;</span><span style="color:rgb(211,52,125)">;</span><span style="color:rgb(218,61,136)">;</span><span style="color:rgb(231,69,149)">;</span><span style="color:rgb(232,69,148)">;</span><span style="color:rgb(214,58,127)">;</span>               <span style="color:rgb(172,38,57)">:</span><span style="color:rgb(185,41,73)">:</span><span style="color:rgb(196,49,89)">:</span><span style="color:rgb(203,54,103)">;</span><span style="color:rgb(214,65,120)">;</span><span style="color:rgb(223,79,138)">+</span><span style="color:rgb(223,85,144)">+</span>       
          <span style="color:rgb(184,49,64)">:</span><span style="color:rgb(199,47,76)">:</span><span style="color:rgb(206,48,94)">:</span><span style="color:rgb(213,59,114)">;</span><span style="color:rgb(217,72,132)">;</span><span style="color:rgb(224,82,145)">+</span><span style="color:rgb(226,84,149)">+</span><span style="color:rgb(213,83,146)">+</span>                              
             <span style="color:rgb(191,56,85)">:</span><span style="color:rgb(198,56,106)">;</span>                                 ` }),
}

function executeCommand() {
  const cmd = currentInput.value.trim()
  lines.value.push({ type: 'prompt', cwd: cwd.value, cmd })

  if (cmd === '') {
    // empty
  } else if (cmd === 'clear') {
    lines.value = []
  } else if (cmd === 'nvim' || cmd.startsWith('nvim ')) {
    const arg = cmd.slice(4).trim()
    nvimInitialFile.value = arg
    nvimMode.value = true
  } else if (commands[cmd]) {
    const output = commands[cmd]()
    if (typeof output === 'object' && output.html) {
      lines.value.push({ type: 'output', text: output.text, html: true })
    } else if (output !== '__CLEAR__') {
      lines.value.push({ type: 'output', text: output as string })
    }
  } else {
    lines.value.push({ type: 'output', text: `zsh: command not found: ${cmd}` })
  }

  currentInput.value = ''
  nextTick(() => {
    termBody.value?.scrollTo(0, termBody.value.scrollHeight)
  })
}

function exitNvim() {
  nvimMode.value = false
  nextTick(() => {
    inputEl.value?.focus()
  })
}

function focusInput() {
  inputEl.value?.focus()
}

onMounted(() => {
  inputEl.value?.focus()
})
</script>
