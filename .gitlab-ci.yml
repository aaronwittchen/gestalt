include:
  - component: gitlab.pinksalad.local/root/ci-components/trivy@main
    inputs:
      fail_on_vulnerabilities: "true"
  - component: gitlab.pinksalad.local/root/ci-components/bun-audit@main
    inputs:
      fail_on_vulnerabilities: "true"
  - component: gitlab.pinksalad.local/root/ci-components/bun-outdated@main
  - component: gitlab.pinksalad.local/root/ci-components/eslint-vue@main
    inputs:
      fail_on_errors: "true"
  - component: gitlab.pinksalad.local/root/ci-components/astro-check@main
    inputs:
      fail_on_errors: "true"
  - component: gitlab.pinksalad.local/root/ci-components/stylelint-vue@main
    inputs:
      fail_on_errors: "true"
  - component: gitlab.pinksalad.local/root/ci-components/bun-build@main
  # - component: gitlab.pinksalad.local/root/ci-components/lighthouse-ci@main
  #   inputs:
  #     fail_on_errors: "true"
  - component: gitlab.pinksalad.local/root/ci-components/lychee@main
    inputs:
      fail_on_errors: "true"
  - component: gitlab.pinksalad.local/root/ci-components/html-validate@main
    inputs:
      fail_on_errors: "true"
  - component: gitlab.pinksalad.local/root/ci-components/github-mirror@main
    inputs:
      github_repo: "https://github.com/aaronwittchen/gestalt.git"

stages:
  - test
  - build
  - quality
  - publish
  - deploy
  - verify

publish-image:
  stage: publish
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  variables:
    REGISTRY: gitlab.pinksalad.local:5050
    IMAGE_TAG: ${REGISTRY}/root/gestalt:$CI_COMMIT_SHORT_SHA
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context $CI_PROJECT_DIR
      --dockerfile $CI_PROJECT_DIR/Dockerfile
      --destination $IMAGE_TAG
      --skip-tls-verify
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy-dev:
  stage: deploy
  image: alpine:latest
  variables:
    IMAGE_TAG: $CI_COMMIT_SHORT_SHA
    GITOPS_REPO: https://oauth2:${GITOPS_TOKEN}@gitlab.pinksalad.local/root/gitops-manifests.git
    GIT_SSL_NO_VERIFY: "true"
  before_script:
    - apk add --no-cache git curl jq
  script:
    - git clone $GITOPS_REPO /tmp/k8s-development
    - cd /tmp/k8s-development/apps/gestalt/overlays/dev
    - "sed -i \"s/newTag: .*/newTag: $IMAGE_TAG/\" kustomization.yaml"
    - git config user.email "ci@gestalt"
    - git config user.name "GitLab CI"
    - git add .
    - git commit -m "deploy gestalt dev $IMAGE_TAG"
    - git push
    - |
      PIHOLE_URL="http://192.168.2.100"
      RESP=$(curl -s -X POST "$PIHOLE_URL/api/auth" -H "Content-Type: application/json" -d "{\"password\":\"$PIHOLE_PASSWORD\"}")

      SID=$(echo "$RESP" | jq -r ".session.sid")
      CSRF=$(echo "$RESP" | jq -r ".session.csrf")

      if [ -z "$SID" ] || [ "$SID" = "null" ]; then
        echo "ERROR: Failed to authenticate with Pi-hole"
        exit 1
      fi

      DNS_RESP=$(curl -s -w "\n%{http_code}" -X PUT \
        "$PIHOLE_URL/api/config/dns/hosts/192.168.2.200%20gestalt-dev.pinksalad.local" \
        -H "Cookie: sid=$SID" -H "X-FTL-SID: $SID" -H "X-FTL-CSRF: $CSRF")

      HTTP_CODE=$(echo "$DNS_RESP" | tail -1)
      DNS_BODY=$(echo "$DNS_RESP" | sed '$d')

      if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
        echo "DNS registered: gestalt-dev.pinksalad.local -> 192.168.2.200"
      elif [ "$HTTP_CODE" = "400" ]; then
        echo "DNS entry already exists (HTTP 400), skipping."
      else
        echo "ERROR: Pi-hole DNS registration failed (HTTP $HTTP_CODE): $DNS_BODY"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

verify-dev:
  stage: verify
  image: alpine:latest
  needs: [deploy-dev]
  variables:
    ARGOCD_URL: "https://192.168.2.140:30443"
    ARGOCD_APP: "gestalt-dev"
    POLL_INTERVAL: "10"
    TIMEOUT: "300"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      TOKEN=$(curl -skf -X POST "$ARGOCD_URL/api/v1/session" \
        -H "Content-Type: application/json" \
        -d "{\"username\":\"admin\",\"password\":\"$ARGOCD_ADMIN_PASSWORD\"}" \
        | jq -r '.token')

      if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
        echo "ERROR: Failed to authenticate with ArgoCD"
        exit 1
      fi

      echo "Triggering ArgoCD sync for '$ARGOCD_APP'..."
      SYNC_RESP=$(curl -skf -X POST \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{}' \
        "$ARGOCD_URL/api/v1/applications/$ARGOCD_APP/sync" 2>/dev/null) || {
        echo "WARNING: Failed to trigger sync, will wait for automatic sync"
      }

      sleep 5
      echo "Waiting for ArgoCD app '$ARGOCD_APP' to become healthy..."
      ELAPSED=0

      while [ "$ELAPSED" -lt "$TIMEOUT" ]; do
        RESPONSE=$(curl -skf \
          -H "Authorization: Bearer $TOKEN" \
          "$ARGOCD_URL/api/v1/applications/$ARGOCD_APP" 2>/dev/null) || {
          echo "[${ELAPSED}s] ArgoCD API unreachable, retrying..."
          sleep "$POLL_INTERVAL"
          ELAPSED=$((ELAPSED + POLL_INTERVAL))
          continue
        }

        SYNC=$(echo "$RESPONSE" | jq -r '.status.sync.status')
        HEALTH=$(echo "$RESPONSE" | jq -r '.status.health.status')
        echo "[${ELAPSED}s] sync=$SYNC health=$HEALTH"

        if [ "$SYNC" = "Synced" ] && [ "$HEALTH" = "Healthy" ]; then
          echo "Deploy verified: app is synced and healthy."
          exit 0
        fi

        if [ "$HEALTH" = "Degraded" ]; then
          echo "ERROR: App health is Degraded."
          exit 1
        fi

        sleep "$POLL_INTERVAL"
        ELAPSED=$((ELAPSED + POLL_INTERVAL))
      done

      echo "ERROR: Timed out after ${TIMEOUT}s. Last state: sync=$SYNC health=$HEALTH"
      exit 1
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
